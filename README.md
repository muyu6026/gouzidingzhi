![:name](https://count.getloli.com/@astrbot_plugin_message_stats?name=astrbot_plugin_message_stats&theme=green&padding=7&offset=0&align=top&scale=1&pixelated=1&darkmode=auto&prefix=0)

# AstrBot 狗子定制

一个功能强大的AstrBot群消息统计插件并结合狗子群内积分处理，支持自动统计群成员发言次数并生成排行榜。

## 📖 使用方法

### 基础命令

#### 查看排行榜
- `#发言榜` - 查看总发言排行榜
- `#今日发言榜` - 查看今日发言排行榜  
- `#本周发言榜` - 查看本周发言排行榜
- `#本月发言榜` - 查看本月发言排行榜

#### 管理命令
- `#更新发言统计` - 手动记录当前用户发言
- `#设置发言榜数量 [数量]` - 设置排行榜显示人数（1-100）
- `#设置发言榜图片 [模式]` - 设置显示模式（1=图片，0=文字）
- `#清除发言榜单` - 清除本群发言统计数据

#### 缓存管理命令
- `#刷新发言榜群成员缓存` - 手动刷新群成员缓存
- `#发言榜缓存状态` - 查看缓存状态

#### 定时功能命令
- `#发言榜定时状态` - 查看定时任务状态
- `#手动推送发言榜` - 手动推送排行榜
- `#设置发言榜定时时间 [时间]` - 设置定时推送时间
- `#设置发言榜定时群组 [群号]` - 添加定时推送群组
- `#设置发言榜定时群组 [群号1] [群号2]` - 添加多个定时推送群组
- `#删除发言榜定时群组 [群号]` - 删除定时推送群组
- `#启用发言榜定时` - 启用定时推送
- `#禁用发言榜定时` - 禁用定时推送
- `#设置发言榜定时类型 [类型]` - 设置定时推送类型

### 使用示例

```
#发言榜
总发言排行榜
发言总数: 156
━━━━━━━━━━━━━━
第1名：小明·45次（占比28.85%）
第2名：小红·32次（占比20.51%）
第3名：小刚·28次（占比17.95%）
```

```
#设置发言榜数量 10
排行榜显示人数已设置为 10 人！
```

```
#设置发言榜图片 1
排行榜显示模式已设置为 图片模式！
```

```
#设置发言榜定时时间 20:00
定时推送时间已设置为 20:00
```

## ⚙️ 配置说明

### 插件配置
插件支持以下配置选项：
- `rand`: 排行榜显示人数（默认20人，范围1-100）
- `if_send_pic`: 显示模式（1=图片模式，0=文字模式）
- `timer_enabled`: 定时推送开关（0=关闭，1=开启）
- `timer_time`: 定时推送时间（格式：HH:MM）
- `timer_groups`: 定时推送群组列表
- `timer_type`: 定时推送类型（1=图片，0=文字）

### 配置方式
1. 通过命令配置（推荐）
2. 编辑配置文件：`data/config.json`

## 📁 文件结构

```
astrbot_plugin_message_stats/
├── main.py                 # 主程序文件
├── metadata.yaml          # 插件元数据
├── README.md              # 说明文档
├── requirements.txt       # 依赖包
├── config.yaml           # 配置文件
├── example_config.json   # 配置示例
├── _conf_schema.json     # 配置架构
├── test_timer_feature.py # 定时功能测试
├── data/                 # 数据目录
│   └── config.json       # 用户配置
├── templates/            # 模板目录
│   ├── __init__.py
│   ├── rank_template.html # 排行榜模板
│   └── user_item_macro.html # 用户项模板
└── utils/                # 工具模块
    ├── __init__.py
    ├── data_manager.py   # 数据管理
    ├── data_stores.py    # 数据存储
    ├── date_utils.py     # 日期工具
    ├── file_utils.py     # 文件工具
    ├── image_generator.py # 图片生成
    ├── models.py         # 数据模型
    ├── timer_manager.py  # 定时管理
    └── validators.py     # 数据验证
```

## 📝 更新日志

## V1.6.4 (2025-12-12)
- 🔧 **修复"排行信息"命令无响应问题**：修复了排行信息命令无法正常响应的问题
- 🔧 **修复管理员操作无响应问题**：修复了修改修为、阅历、积分时没有回复信息的问题
- 🔧 **优化管理员操作响应格式**：按照要求修改响应格式为"已（增加、减少）xx（用户名）xx（修为、阅历、积分）为xx（修改的值）"
- 🔧 **修复"排行信息"命令艾特限制**：现在"排行信息"命令不需要艾特机器人也可以触发
- 🔧 **修复"查看个人信息"命令显示乱码**：解决了显示Plain组件对象而不是纯文本的问题
- 🔧 **统一消息响应处理**：所有命令响应现在统一使用`event.plain_result()`方法，确保消息正确显示

## V1.6.3 (2025-11-25)
- 🗑️ **删除每周排行榜推送功能**：完全移除每周阅历排行榜奖励推送功能，避免重复推送和用户投诉
- 🔧 **简化代码结构**：移除了`_weekly_experience_reset`、`_give_weekly_rewards_optimized`和`_send_weekly_reward_message`方法
- 📝 **更新文档**：在代码中添加了注释说明移除原因，便于后续维护

## V1.6.2 (2025-11-23)
- 🔧 **进一步修复排行榜推送重复问题**：增强了防重复机制，添加群组级别的检查
- 🔧 **优化存档检查逻辑**：在发送消息前标记已发送，防止并发导致的重复
- 🔧 **增强日志记录**：添加更详细的日志信息，便于调试和监控

## V1.6.1 (2025-11-23)
- 🔧 **修复Plain组件显示问题**：解决不艾特机器人时显示`Plain(type=<ComponentType.Plain: 'Plain'>, text='...', convert=True)`的问题
- 🔧 **优化每周重置功能**：不清空用户修为和阅历，只发送奖励通知
- 🔧 **修复排行榜推送重复问题**：确保每周只推送一次奖励消息，避免重复推送
- 🔧 **增强消息处理逻辑**：改进了`_process_message_result`方法，优先处理Plain组件对象
- 🔧 **优化Rbot功能**：所有Rbot相关方法现在直接返回字符串，避免Plain组件问题

## V1.6.0
- 🎉 初始版本发布
- 📊 支持群消息统计和排行榜生成
- ⏰ 支持定时推送功能
- 🎮 集成Rbot游戏功能
- 🖼️ 支持图片和文字两种显示模式

## V1.0

## 👨‍💻 作者

**xiaoruange39**
- GitHub: [@xiaoruange39](https://github.com/muyu6026)
- 插件开发：暮雨

## 🙏 致谢

感谢以下项目和插件的参考：
- [AstrBot框架](https://github.com/SKStudio/AstrBot) - 强大的多平台聊天机器人框架
- [AstrBot 群发言统计插件](https://github.com/xiaoruange39/astrbot_plugin_message_stats)- 基础架构参考
- [yunzai-plugin-example](https://github.com/KaedeharaLu/yunzai-plugin-example) - 原始插件基础架构参考
- AstrBot社区 - 提供的开发文档和技术支持

---

**如果这个插件对您有帮助，请给个⭐支持一下！**
